<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Iceberg Tier List</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a1a;
      color: #fff;
      height: 100%;
      overflow-x: hidden;
      position: relative;
    }
    #background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      z-index: -1;
      transition: filter 0.3s;
    }
    #background.blurred {
      filter: blur(5px);
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    #menuToggle {
      display: none;
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1100;
      font-size: 1.5rem;
      background: rgba(0, 0, 0, 0.8);
      border: none;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
    }
    .tier {
      display: flex;
      align-items: center;
      min-height: 120px;
      margin: 15px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.15);
      border: 2px solid #555;
      border-radius: 12px;
      overflow-x: auto;
      position: relative;
      transition: transform 0.2s;
    }
    .tier-label {
      min-width: 60px;
      font-weight: bold;
      writing-mode: vertical-rl;
      text-orientation: mixed;
      margin-right: 10px;
      padding: 5px;
      font-size: 1rem;
      background: #333;
      border-radius: 6px;
      user-select: none;
    }
    .tier-actions {
      position: absolute;
      top: 5px;
      right: 10px;
      display: flex;
      gap: 6px;
    }
    .image-box {
      width: 100px;
      height: 100px;
      margin: 5px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: 1px solid #fff;
      border-radius: 6px;
      position: relative;
      transition: transform 0.2s;
      cursor: move;
    }
    .image-box:hover {
      transform: scale(1.1);
      z-index: 2;
    }
    #tierlist {
      margin-top: 80px;
      padding-bottom: 20px;
    }
    button, label {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: none;
      border-radius: 6px;
      background: #444;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover, label:hover {
      background: #666;
    }
    #modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }
    #modalContent {
      background: #222;
      color: #fff;
      padding: 20px;
      border-radius: 12px;
      max-width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      width: 400px;
    }
    #modalContent img {
      max-width: 100%;
      max-height: 200px;
      border-radius: 8px;
    }
    #modalTitle, #modalDesc {
      width: 100%;
      margin: 10px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #333;
      color: #fff;
    }
    #modalDesc {
      min-height: 80px;
      resize: vertical;
    }
    .tier-container {
      display: flex;
      flex-direction: column;
    }
    @media (max-width: 600px) {
      #controls {
        display: none;
      }
      #controls.active {
        display: flex;
        flex-direction: column;
        width: 200px;
        left: 10px;
        top: 50px;
      }
      #menuToggle {
        display: block;
      }
      .tier {
        min-height: 100px;
        margin: 10px;
      }
      .tier-label {
        min-width: 50px;
        font-size: 0.9rem;
      }
      .image-box {
        width: 80px;
        height: 80px;
      }
      #tierlist {
        margin-top: 60px;
      }
      button, label {
        padding: 10px;
        font-size: 1rem;
      }
      #modalContent {
        width: 90%;
        max-height: 90vh;
      }
    }
  </style>
</head>
<body>
  <div id="background"></div>
  <button id="menuToggle" onclick="toggleMenu()">‚ò∞</button>
  <div id="controls">
    <label><input type="file" id="uploadImage" accept="image/*" multiple style="display:none;"/>üì§ Upload Images</label>
    <button onclick="addTier()">‚ûï Add Tier</button>
    <button onclick="toggleTheme()">üé® Theme</button>
    <button onclick="toggleBlur()">üåÄ Blur Background</button>
    <label><input type="file" id="uploadBackground" accept="image/*" style="display:none;"/>üåÑ Background</label>
    <button onclick="saveData()">üíæ Save JSON</button>
    <button onclick="loadData()">üìÇ Load JSON</button>
    <button onclick="exportPNG()">üñºÔ∏è PNG</button>
    <button onclick="exportPDF()">üìÑ PDF</button>
    <input type="file" id="loadFile" accept="application/json" style="display:none;">
  </div>

  <div class="tier-container" id="tierlist"></div>

  <div id="modal">
    <div id="modalContent">
      <h3>Edit Image Info</h3>
      <img id="modalImg" />
      <input id="modalTitle" placeholder="Title" />
      <textarea id="modalDesc" placeholder="Description"></textarea>
      <button onclick="closeModal()">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    let tiers = [];
    let currentImageBox = null;

    function addTier(name = "New Tier", color = "#222") {
      const tierList = document.getElementById("tierlist");
      const tier = document.createElement("div");
      tier.className = "tier";
      tier.dataset.color = color;

      const label = document.createElement("div");
      label.className = "tier-label";
      label.innerText = name;
      tier.appendChild(label);

      const tierContent = document.createElement("div");
      tierContent.className = "tier-content";
      tierContent.style.display = "flex";
      tierContent.style.flex = "1";
      tierContent.style.overflowX = "auto";
      tier.appendChild(tierContent);

      const tierActions = document.createElement("div");
      tierActions.className = "tier-actions";
      tierActions.innerHTML = `<button onclick="this.closest('.tier').remove(); saveToURL()">üóëÔ∏è</button>`;
      tier.appendChild(tierActions);

      tierList.appendChild(tier);
      new Sortable(tierContent, {
        group: "shared",
        animation: 150,
        ghostClass: "sortable-ghost",
        filter: ".tier-label, .tier-actions",
        onEnd: saveToURL
      });
      new Sortable(tierList, {
        handle: ".tier-label",
        animation: 150,
        ghostClass: "sortable-ghost",
        filter: ".tier-content, .tier-actions",
        onEnd: saveToURL
      });
      saveToURL();
    }

    function handleImageUpload(event) {
      const files = Array.from(event.target.files);
      if (files.length === 0) return;
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          const imageBox = document.createElement("div");
          imageBox.className = "image-box";
          imageBox.style.backgroundImage = `url(${e.target.result})`;
          imageBox.dataset.src = e.target.result;
          imageBox.onclick = () => openModal(imageBox);
          const lastTier = document.querySelector(".tier:last-child .tier-content") || 
                          document.querySelector(".tier .tier-content") || 
                          (addTier(), document.querySelector(".tier:last-child .tier-content"));
          lastTier.appendChild(imageBox);
          saveToURL();
        };
        reader.readAsDataURL(file);
      });
    }

    function handleBackgroundUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const bgDiv = document.getElementById("background");
        bgDiv.style.backgroundImage = `url(${e.target.result})`;
        bgDiv.style.backgroundColor = 'transparent'; // Ensure no color override
        saveToURL();
      };
      reader.readAsDataURL(file);
    }

    function openModal(imageBox) {
      currentImageBox = imageBox;
      document.getElementById("modalImg").src = imageBox.dataset.src;
      document.getElementById("modalTitle").value = imageBox.dataset.title || "";
      document.getElementById("modalDesc").value = imageBox.dataset.desc || "";
      document.getElementById("modal").style.display = "flex";
    }

    function closeModal() {
      if (currentImageBox) {
        currentImageBox.dataset.title = document.getElementById("modalTitle").value;
        currentImageBox.dataset.desc = document.getElementById("modalDesc").value;
      }
      document.getElementById("modal").style.display = "none";
      saveToURL();
    }

    document.getElementById("uploadImage").addEventListener("change", handleImageUpload);
    document.getElementById("uploadBackground").addEventListener("change", handleBackgroundUpload);

    function toggleTheme() {
      document.body.classList.toggle("light-theme");
      const isLight = document.body.classList.contains("light-theme");
      document.body.style.backgroundColor = isLight ? "#f0f0f0" : "#1a1a1a";
      document.querySelectorAll(".tier").forEach(tier => {
        tier.style.background = isLight ? "rgba(0, 0, 0, 0.1)" : "rgba(255, 255, 255, 0.15)";
      });
      document.querySelectorAll(".tier-label").forEach(label => {
        label.style.background = isLight ? "#ddd" : "#333";
      });
    }

    function toggleBlur() {
      document.getElementById("background").classList.toggle("blurred");
    }

    function toggleMenu() {
      const controls = document.getElementById("controls");
      controls.classList.toggle("active");
      controls.style.display = controls.classList.contains("active") ? "flex" : "none";
    }

    function saveData() {
      try {
        const data = exportState();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "tierlist.json";
        a.click();
      } catch (e) {
        alert("Error saving JSON: " + e.message);
      }
    }

    function loadData() {
      document.getElementById("loadFile").click();
    }

    document.getElementById("loadFile").addEventListener("change", function(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          importState(data);
          saveToURL();
        } catch (e) {
          alert("Error loading JSON: Invalid file format.");
        }
      };
      reader.readAsText(file);
    });

    function exportState() {
      return {
        tiers: Array.from(document.querySelectorAll(".tier")).map(tier => ({
          label: tier.querySelector(".tier-label").innerText,
          color: tier.dataset.color,
          images: Array.from(tier.querySelectorAll(".image-box")).map(img => ({
            src: img.dataset.src,
            title: img.dataset.title || "",
            desc: img.dataset.desc || ""
          }))
        })),
        background: document.getElementById("background").style.backgroundImage
      };
    }

    function importState(data) {
      document.getElementById("tierlist").innerHTML = "";
      data.tiers.forEach(t => {
        addTier(t.label, t.color);
        const lastTierContent = document.querySelector(".tier:last-child .tier-content");
        t.images.forEach(i => {
          const box = document.createElement("div");
          box.className = "image-box";
          box.style.backgroundImage = `url(${i.src})`;
          box.dataset.src = i.src;
          box.dataset.title = i.title;
          box.dataset.desc = i.desc;
          box.onclick = () => openModal(box);
          lastTierContent.appendChild(box);
        });
      });
      if (data.background) {
        const bgDiv = document.getElementById("background");
        bgDiv.style.backgroundImage = data.background;
        bgDiv.style.backgroundColor = 'transparent';
      }
    }

    function saveToURL() {
      const data = LZString.compressToEncodedURIComponent(JSON.stringify(exportState()));
      history.replaceState(null, "", `#${data}`);
    }

    function exportPNG() {
      document.getElementById("controls").style.display = "none";
      document.getElementById("menuToggle").style.display = "none";
      html2canvas(document.getElementById("tierlist"), { 
        scale: 4,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const a = document.createElement("a");
        a.download = "tierlist.png";
        a.href = canvas.toDataURL("image/png", 1.0);
        a.click();
        document.getElementById("controls").style.display = "flex";
        document.getElementById("menuToggle").style.display = window.innerWidth <= 600 ? "block" : "none";
      }).catch(e => alert("Error exporting PNG: " + e.message));
    }

    function exportPDF() {
      document.getElementById("controls").style.display = "none";
      document.getElementById("menuToggle").style.display = "none";
      html2canvas(document.getElementById("tierlist"), { 
        scale: 4,
        useCORS: true,
        logging: false
      }).then(canvas => {
        const imgData = canvas.toDataURL("image/png", 1.0);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
          orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
          unit: 'mm',
          format: 'a4'
        });
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        const imgWidth = canvas.width * 0.264583;
        const imgHeight = canvas.height * 0.264583;
        const scale = Math.min(pageWidth / imgWidth, pageHeight / imgHeight);
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth * scale, imgHeight * scale, null, 'SLOW');
        pdf.save("tierlist.pdf");
        document.getElementById("controls").style.display = "flex";
        document.getElementById("menuToggle").style.display = window.innerWidth <= 600 ? "block" : "none";
      }).catch(e => alert("Error exporting PDF: " + e.message));
    }

    // Auto-load from URL hash
    if (location.hash.length > 1) {
      try {
        const data = JSON.parse(LZString.decompressFromEncodedURIComponent(location.hash.slice(1)));
        importState(data);
      } catch (e) {
        console.error("Error loading from URL:", e);
        addTier("Top");
        addTier("Middle");
        addTier("Bottom");
      }
    } else {
      addTier("Top");
      addTier("Middle");
      addTier("Bottom");
    }

    // Ensure controls visibility based on screen size
    window.addEventListener("resize", () => {
      const controls = document.getElementById("controls");
      const menuToggle = document.getElementById("menuToggle");
      if (window.innerWidth > 600) {
        controls.style.display = "flex";
        controls.classList.remove("active");
        menuToggle.style.display = "none";
      } else {
        controls.style.display = controls.classList.contains("active") ? "flex" : "none";
        menuToggle.style.display = "block";
      }
    });
    // Trigger initial visibility
    window.dispatchEvent(new Event("resize"));
  </script>
</body>
</html>
